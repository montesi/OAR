function Hall=geom3D_plot(angles,is_symm)
% function Hall=geom3D_plot(angles,is_symm)
% Plot geometry of model.
%%% Input %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% angles: structure containings the various angles in the flow solution
% xb, zb: starting point coordinates (assumes yb=0)
%%% Dependencies %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dependencies: TH_fun, TH_ODE
%%% Output %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Hall: handles of various geometrical elements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%plot_lithosphere

ap=(angles.beta+angles.delta)/2;
yb=2;
if is_symm
    if ap>pi/4
        yl=[0 0 0 0;...
            0 0 0 0;...
            1 1 1 1;...
            1 1 1 1]*2;
        xl=[0 1 1 0;...
            0 1 1 0;...
            0 1 1 0;...
            0 1 1 0];
        zl=[0 0 0 0;...
            0 1/tan(ap) 0 0;...
            0 1/tan(ap) 0 0;...
            0 0 0 0];
        Hall(6)=fill3([0,1,1,0,0],[1,1,0,0,1]*yb,[0,1,1,0,0]/tan(ap),[1,1,1]*0.8);
    else
        yl=[0 0 0 0 0;...
            0 0 0 0 0;...
            1 1 1 1 1;...
            1 1 1 1 1]*2;
        xl=[0 tan(ap) 1 1 0;...
            0 tan(ap) 1 1 0;...
            0 tan(ap) 1 1 0;...
            0 tan(ap) 1 1 0];
        zl=[0 0 0 0 0;...
            0 1 1 0 0;...
            0 1 1 0 0;...
            0 0 0 0 0];
        Hall(6)=fill3([0,1,1,0,0]*tan(ap),[1,1,0,0,1]*yb,[0,1,1,0,0],[1,1,1]*0.8);
    end
    Hall(1)=surf(xl,yl,zl,'facecolor',[0.5,1,0.75]/2);
    hold on;
    Hall(2)=plot3([0,0,0,0,0],[1,1,0,0,1]*yb,[0,1,1,0,0],'k');
    Hall(3)=plot3([0,0,0,0,0]+1,[1,1,0,0,1]*yb,[0,1,1,0,0],'k');
    Hall(4)=plot3([0,1,1,0,0],[0,0,0,0,0]+yb,[0,0,1,1,0],'k');
    Hall(5)=plot3([0,1,1,0,0],[0,0,0,0,0]-yb,[0,0,1,1,0],'k');

else
    am=(angles.beta-angles.delta)/2;
    if ap>pi/4
        if am>pi/4
            yl=[-1 -1 -1 -1 -1 -1;...
                -1 -1 -1 -1 -1 -1;...
                1 1 1 1 1 1;...
                1 1 1 1 1 1]*2;
            xl=[-1 -1 0 1 1 -1;...
                -1 -1 0 1 1 -1;...
                -1 -1 0 1 1 -1;...
                -1 -1 0 1 1 -1];
            zl=[0 0 0 0 0 0;...
                0 1/tan(am) 0 1/tan(ap) 0 0;...
                0 1/tan(am) 0 1/tan(ap) 0 0;...
                0 0 0 0 0 0];
        else
            yl=[-1 -1 -1 -1 -1 -1 -1;...
                -1 -1 -1 -1 -1 -1 -1;...
                1 1 1 1 1 1 1;...
                1 1 1 1 1 1 1]*2;
            xl=[-1 -1 0 0 1 1 -1;...
                -1 -1 -tan(am)  0 1 1 -1;...
                -1 -1 -tan(am)  0 1 1 -1;...
                -1 -1 0  0 1 1 -1];
            zl=[0 0 0 0 0 0 0;...
                0 1 1 0 1/tan(ap) 0 0;...
                0 1 1 0 1/tan(ap) 0 0;...
                0 0 0 0 0 0 0];
        end
    else
        if am>pi/4
            yl=[-1 -1 -1 -1 -1 -1 -1;...
                -1 -1 -1 -1 -1 -1 -1;...
                1 1 1 1 1 1 1;...
                1 1 1 1 1 1 1]*2;
            xl=[-1 -1 0 0 1 1 -1;...
                -1 -1 0 tan(ap) 1 1 -1;...
                -1 -1 0 tan(ap) 1 1 -1;...
                -1 -1 0 0 1 1 -1];
            zl=[0 0 0 0 0 0 0;...
                0 1/tan(am) 0 1 1 0 0;...
                0 1/tan(am) 0 1 1 0 0;...
                0 0 0 0 0 0 0]; 
        else
            yl=[-1 -1 -1 -1 -1 -1 -1 -1;...
                -1 -1 -1 -1 -1 -1 -1 -1;...
                1 1 1 1 1 1 1 1;...
                1 1 1 1 1 1 1 1]*2;
            xl=[-1 -1 0 0 0 1 1 -1;...
                -1 -1 -tan(am)  0 tan(ap) 1 1 -1;...
                -1 -1 -tan(am)  0 tan(ap) 1 1 -1;...
                -1 -1 0 0 0 1 1 -1];
            zl=[0 0 0 0 0 0 0 0;...
                0 1 1 0 1 1 0 0;...
                0 1 1 0 1 1 0 0;...
                0 0 0 0 0 0 0 0]; 
        end
    end
    Hall(1)=surf(xl,yl,zl,'facecolor',[0.5,1,0.75]/2);
    hold on;
    Hall(2)=plot3([0,0,0,0,0]-1,[1,1,-1,-1,1]*yb,[0,1,1,0,0],'k');
    Hall(3)=plot3([0,0,0,0,0]+1,[1,1,-1,-1,1]*yb,[0,1,1,0,0],'k');
    Hall(4)=plot3([-1,1,1,-1,-1],[0,0,0,0,0]+yb,[0,0,1,1,0],'k');
    Hall(5)=plot3([-1,1,1,-1,-1],[0,0,0,0,0]-yb,[0,0,1,1,0],'k');

    thmid=fzero(@(x) TH_fun(x,angles.A,angles.B,angles.C,angles.D),0);
    if thmid<pi/4;
        Hall(6)=fill3([0,0,1,1,0]*tan(thmid),[1,-1,-1,1,1]*yb,[0,0,1,1,0],[1,1,1]*0.8);
    else
        Hall(6)=fill3([0,0,1,1,0],[1,-1,-1,1,1]*yb,[0,0,1,1,0]/tan(thmid),[1,1,1]*0.8);
    end
end
alpha(Hall(1),0.3);
alpha(Hall(6),0.3);
set(Hall(6),'linewidth',1)
